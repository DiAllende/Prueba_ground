{% extends 'core/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'core/css/registro.css'%}" rel="stylesheet">

<br>
<br>
<br>

<h2>Registro de Usuario</h2>
<form method="post" class="user-registration-form">
  {% csrf_token %}
  <div class="form-group">
    <label for="{{ form.email.id_for_label }}">Email:</label>
    {{ form.email }}
    <div class="error-message">
      {{ form.email.errors }}
    </div>
  </div>

  <div class="form-group">
    <label for="{{ form.password1.id_for_label }}">Contraseña:</label>
    <div class="input-field">
      {{ form.password1 }}
      <div class="password-requirements">
        <ul>
          <li>Debe contener al menos 8 caracteres.</li>
          <li>Debe contener al menos una letra mayúscula y una minúscula.</li>
          <li>Debe contener al menos un número.</li>
          <li>Puede contener caracteres especiales.</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="form-group">
    <label for="{{ form.password2.id_for_label }}">Confirmar contraseña:</label>
    {{ form.password2 }}
    <div class="password-requirements2">
      <ul>
        <li>Debe ser igual a la contraseña de arriba, de no ser así, ambas quedarán en blanco.</li>
      </ul>
      <div class="error-message">
        {% if form.errors.password2 %}
          {% for error in form.errors.password2 %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
  <div class="form-group">
    <label for="{{ form.nombre.id_for_label }}">Nombre:</label>
    {{ form.nombre }}
  </div>
  <div class="form-group">
    <label for="{{ form.rut.id_for_label }}">RUT:</label>
    {{ form.rut }}
    <div class="error-message">
      {{ form.rut.errors }}
    </div>
  </div>
  <div class="form-group">
    <label for="{{ form.direccion.id_for_label }}">Dirección:</label>
    {{ form.direccion }}
  </div>
  <div class="form-group">
    <label for="{{ form.pais.id_for_label }}">País:</label>
    {{ form.pais }}
  </div>
  <div class="form-group">
    <label for="{{ form.codigo_postal.id_for_label }}">Código Postal:</label>
    {{ form.cp }}
  </div>
  <div class="form-group admin-group">
    <div class="admin-input-field">
      <label class="admin-label" for="{{ form.admin.id_for_label }}">Administrador:</label>
      {{ form.admin }}
    </div>
  </div>

  <button type="submit" class="btn btn-primary" id="submit-button">Registrarse</button>
</form>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function validarRut(rut) {
    rut = rut.replace(/[^\dkK]/g, '');

    if (!/^(\d{1,3}(?:\.?\d{3})*)-?([\dkK])$/.test(rut)) {
      return false;
    }

    rut = rut.split('-');
    const num = parseInt(rut[0].replace(/\./g, ''), 10);
    const dv = rut[1].toUpperCase();

    let rutSum = 0;
    let multiplier = 2;

    for (let i = rut[0].length - 1; i >= 0; i--) {
      rutSum += parseInt(rut[0][i]) * multiplier;
      multiplier = multiplier === 7 ? 2 : multiplier + 1;
    }

    const calculatedDv = 11 - (rutSum % 11);
    const expectedDv = calculatedDv === 11 ? '0' : calculatedDv === 10 ? 'K' : String(calculatedDv);

    return dv === expectedDv && rut[0].length >= 7;
  }

  $(document).ready(function() {
    const rutField = $('#id_rut');
    const rutError = $('.error-message');
    const submitButton = $('#submit-button');

    rutField.blur(function() {
    const rutValue = rutField.val();
    let valid = validarRut(rutValue);

    while (!valid) {
      rutError.text('El RUT ingresado no es válido');
      submitButton.prop('disabled', true);

      // Esperar un segundo antes de realizar la próxima validación
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Obtener el valor actualizado del campo del RUT
      const updatedRutValue = rutField.val();
      valid = validarRut(updatedRutValue);
    }

    rutError.text('');
    submitButton.prop('disabled', false);
  });

    const passwordField = $('#id_password1');
    const passwordField2 = $('#id_password2');
    const passwordRequirements = $('.password-requirements');
    const passwordRequirements2 = $('.password-requirements2');

    passwordRequirements.hide();
    passwordRequirements2.hide();

    passwordField.focus(function() {
      passwordRequirements.show();
    });

    passwordField.blur(function() {
      passwordRequirements.hide();
    });

    passwordField2.focus(function() {
      passwordRequirements2.show();
    });

    passwordField2.blur(function() {
      passwordRequirements2.hide();
    });
  });
</script>


{% endblock %}
